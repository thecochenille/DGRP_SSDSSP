---
title: "DGRP Genetic Arch"
author: "Alexander Shingleton"
date: "9/8/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressPackageStartupMessages({
 require(lme4)
require(lmerTest)
require(lattice) # for some of the simple plots
require(MCMCglmm) # To get posterior distributions
require(smatr)
require(dplyr)
require(plyr)
require(rrcov)
require(tibble)
require(ggplot2)
require(ggalt)
require(varhandle)
require(magrittr)
require("ggthemes")
require(pbkrtest)  # parametric bootstrap
require(car)
require(tidyverse)
require(hrbrthemes)
require(viridis)
  require(tidyr)
 })
R.version
```

#Questions

To better understand how SSD and SSP impact each other, we will test the following hypotheses:

**Bigger scope: I want to test if the variation in SSD is due variation in female size generated both by the environment, and genetic variation.**

To keep in mind: if SSD is associated with SSP, that means a part of the genetic variation that affects SSD is due to the genetic variation in SSP.

We know that female plasticity is higher than male's and we want to check if the variation in plasticity is due to female variation in plasticity.

That would imply that evolutionarily, female size would tend to be the one changing and generating SSD.

- Section 1: SSD in fed flies
  - Question 1.1: Is there Sexual Size Dimorphism in the DGRP lines.
  - Question 1.2: Do we see a genetic variation of SSD in the DGRP lines.
  - Question 1.3: Is the SSD genetic variation due to a genetic variation in male or in female size?

- Section 2: SSD in other conditions
  - Question 2.1: Do we have the same SSD when we change environment?
  - Question 2.2: Does SSD increase or decrease when the flies are starved? Our hypothesis is that overall SSD should decrease
  - Question 2.3: Does the SSD in starved conditions vary the same way as in fed flies?

If there SSD differs between environmental conditions, that means that the plasticity in female and male is different.

-Section 3: SSP
  - Question 3.1: Is there SSP when we look at fed vs starved flies?
  - Question 3.2: Does this SSP vary in the DGRP flies?
  - Question 3.3: Is the variation in SSP due to a variation in SSD in fed or starved flies?
If SSP covaries with SSD0, that means that we have variation in fed flies. If SSP covaries with starved flies, we have variation in the reduction of flies size.
  - Question 3.4: If it is due to SSD in either fed or starved flies, is it because the females vary more or the males vary more in size?
  - Question 3.5: Does the variation causing SSP (Question 3.4) is the same as the variation caused by SSD in Question 1.3?




#Data preparation
```{r,message=FALSE, warning=FALSE}
#dataset was manually relabeled and control lines removed
df <- read.csv("~/Dropbox/_Github_reps/DGRP_SSDSSP/Data/DGRPfinal_clean_first_ctrl_only.csv")

#column names
names(df)
```


```{r}
#line and day of treatment as categorical
df$line<-as.factor(df$line)
df$day<-as.factor(df$day)
df$block<-as.factor(df$block)
#summary of data
summary(df)
```


## Filtering out lines with few data
```{r}
#firt, create a column to indicate group by line_sex_day. This will be easier to filter out or subset by group later

df$group<- paste(df$line, df$sex, df$day, sep = "_")
head(df)
```

```{r}
#filtering out groups (line x sex x day) that have less than 10 flies
#NB: check if I run that filter after na omit before each analysis might not be better?
df_sub<-df%>%
group_by(group) %>%
filter(n() >=10)
```


##Is there variation among blocks  ==> do it later
Flies of lineages were collected in different blocks, periods of time. Control lineages were selected and collected repeatedly for each block so that if there is variation, we can account for that factor.

Look at the control lineages to see whether there is variation among blocks

```{r,message=FALSE, warning=FALSE}
#subset control lineages
df0<-subset(df, day =='0')
dfc<-subset(df0, type=="ct")
dfcf<-subset(dfc, sex=="F")
dfcm<-subset(dfc, sex=="M")


#linear mixed model testing pupa size variation and if block factor has an effect on the variation
blocktest<-lmer(pupa~block+(1|line), data=dfc)
Anova(blocktest, type="III")

blocktest2<-lmer(pupa~sex*block+(1|line), data=dfc)
Anova(blocktest2, type="III")

blocktestF<-lmer(pupa~block+(1|line), data=dfcf)
Anova(blocktest, type="III")

blocktestM<-lmer(pupa~block+(1|line), data=dfcm)
Anova(blocktest, type="III")
```

There is a difference between collecting blocks so we have to account for block as a random factor, or adjust the values so there is no variation between blocks.








# SSD in fed flies
  - Question 1.1: Is there Sexual Size Dimorphism in the DGRP lines.
  - Question 1.2: Do we see a genetic variation of SSD in the DGRP lines.
  - Question 1.3: Is the SSD genetic variation due to a genetic variation in male or in female size?


## Question 1.1: Is there Sexual Size Dimorphism in the DGRP flies that are normally fed?
To test if we have sexual size dimorphism, we want to test the effect of size with line and block as random factor. If there is a variation due to sex, that means SSD is present.

```{r,message=FALSE, warning=FALSE}
df<-df_sub  #do not forget to reload data if I want to filter out things differently

#subsetting day 0, fed flies
df0<-subset(df, day==0)

#na.omit only if pupa has NA
df0<-na.omit(df0, cols="pupa")
```

```{r}
# Testing effect of sex in pupa size, with random effect for line and block.
SSD<-lmer(pupa~sex+(1|line) +(1|block), REML=TRUE, data=df0)
summary(SSD)
anova(SSD)
```


```{r}
# plotting male and female size mean
df0 %>%
  ggplot( aes(x=sex, y=pupa, fill=sex)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="black", size=0.4, alpha=0.2) +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("Sexual Size Dimorphism in DGRP flies") +
    xlab("")
```

Answer 1.1: Yes, there is sexual size dimorphism in the DGRP flies, and females are larger than males on average.

## Question 1.2: Do we see a genetic variation of SSD in the DGRP lines.


### Comparing two models using ANOVA
```{r,message=FALSE, warning=FALSE}
#comparing two models
model2<-lmer(pupa~sex+(1|line)+(1|block), data=df0)  #model to test for SSD presence as we did above
model1<-lmer(pupa~sex+(sex|line)+(1|block), data=df0) 
anova(model1)
anova(model1,model2)
```
Model 1 is better, as AIC and BIC is smaller and log likelihood is higher. The difference of fit between these two models is significant.

### Do a LRT
How many parameters for each models
```{r,message=FALSE, warning=FALSE}
(AIC(model1) - REMLcrit(model1))/2 # # of parameters the model "thinks" are being estimated
(AIC(model2) - REMLcrit(model2))/2 # # of parameters the model "thinks" are being estimated

```


So lme4/lmer is treating model 1 as having two more parameters than model2.
```{r,message=FALSE, warning=FALSE}
LR.model <-  -as.numeric(REMLcrit(model1) - REMLcrit(model2))
LR.model
nlevels(df$line)
pchisq(q = LR.model, df=2, lower=F)
pchisq(q = LR.model, df=nlevels(df$line), lower=F)
```

### Parametric boostrap
Finally, we can conduct a parametric bootstrap to compare the two models.

```{r echo=FALSE, message = FALSE, warning=FALSE}
pbtest<-PBmodcomp(model1, model2, nsim=1000, details = 1)
summary(pbtest)
```

### Finally using Bayesian Analysis

```{r,message=FALSE, warning=FALSE}
prior.2 <-list(R=list(V=0.01, nu=0.002), 
               G=list(G1=list(V=0.01*diag(1), nu=0.002),
                      G2=list(V=0.01*diag(2), nu=0.002)))

model1M.MCMC <- MCMCglmm(pupa ~ 1 + sex, 
  random=~block + us(1 + sex):line,
  prior = prior.2, burnin = 5000, nitt = 20000, thin = 10,
  verbose = F, pr = T,
  data=df0)
summary(model1M.MCMC)
```



### Post model 1 fitting check

#### Residual distribution
```{r,message=FALSE, warning=FALSE}
res_model1=residuals(model1)
```

#### Model 1 residual distribution

```{r,message=FALSE, warning=FALSE}
plot(model1)
```




#### QQ plot
```{r,message=FALSE, warning=FALSE}
require(ggpubr)
ggqqplot(res_model1)
```


#### Random effect plot
```{r,message=FALSE, warning=FALSE}
qqmath(ranef(model1))
```
We have two plots, one for line and one for block

## Question 1.3: Is the SSD genetic variation due to a genetic variation in male or in female size?
To test this, I need to look at the correlation between SSD and male size and SSD and female size, the correlation that is higher means that that sex contributes the most to the SSD variation. 

I need to calculate summary for pupa female size, pupa male size and SSD.

```{r}
#calculate means for each group
#head(df0)
df0_mean<-aggregate(df0[, 8], list(df0$group), mean)
#head(df0_mean)

#re-add line, day and sex columns
df0_mean<-df0_mean %>%
  separate(Group.1, c("line", "sex","day"), "_")
head(df0_mean)
```


Size Mean by line plot boxplot for fed flies

```{r}
df0_mean %>%
  ggplot(aes(sex,pupa, fill=sex)) +
  geom_boxplot() +
  geom_point(size=0.5)+ 
  geom_line(aes(group=line, alpha=0.1, linewidth=0.5)) +
  theme(legend.position = "none")

```


```{r}
#calculate SSD
#separating males and females to put the values in columns
df0_mean_F<-subset(df0_mean, sex=="F")
df0_mean_M<-subset(df0_mean, sex=="M")

df0_mean_2<-merge(x=df0_mean_F, y=df0_mean_M, by.x="line", by.y="line")
head(df0_mean_2)

#remove extra columns
df0_mean_2<-df0_mean_2[,c(1,4,7)] 
colnames(df0_mean_2) <- c("line", "pupaF", "pupaM")

df0_mean<-df0_mean_2
df0_mean$SSD0<- df0_mean$pupaF - df0_mean$pupaM  #since we established that females are larger than males in general
head(df0_mean)
```

Correlation test
```{r}
library(psych)

corr.test(df0_mean[2:4],
          use    = "pairwise",
          method = "pearson",
          adjust = "none")
```




```{r}

library(PerformanceAnalytics)

chart.Correlation(df0_mean[2:4],
                   method="pearson",
                   histogram=TRUE,
                   pch=16)
```
It seems that SSD in fed flies co-varies with the most with female size. The R2 is not very high though, so it is not all that explains SSD0 variation.



Does female size vary more genetically than male size?

One tail variance F test


```{r}
#Before performing the F test, I need to check that both samples are normally distributed.
require(ggpubr)
ggqqplot(df0_mean$pupaF)
ggqqplot(df0_mean$pupaM)


shapiro.test(df0_mean$pupaM) #normal distribution
shapiro.test(df0_mean$pupaF) #normal distribution


#one tail F test

var.test(df0_mean$pupaF, df0_mean$pupaM, alternative = "greater")
```



The variance in female size is actually not bigger than that of male size, despite the higher correlation between female size and SSD0, than male size and SS0. So does it mean that SSD0 varies partly because of a co-variation with female size but not from the fact that female size varies more genetically? So where does that SSD variation come from?


# Section 2: SSD in other conditions
We found that in fed flies, females are on average larger than males, so there is a female biased SSD. That SSD also vary genetically. We finally found out that SSD variation is in part driven by the genetic variation of female size, although the variance of female size is the same as male size.

Let's look at different starving conditions

  - Question 2.1: Do we have the same SSD when we change environment?
  - Question 2.2: Does SSD increase or decrease when the flies are starved? Our hypothesis is that overall SSD should decrease
  - Question 2.3: Does the SSD in starved conditions vary the same way as in fed flies?
  
## Question 2.1: Do we have the same SSD when we change environment?
### 1 day starvation data
```{r}
#subset day 1 and day 2 starvation
df1<-subset(df_sub, day==1) #7755 rows
#na.omit only if pupa has NA
df1<-na.omit(df1, cols="pupa") #6409 rows
```

```{r}
# Testing effect of sex in pupa size, with random effect for line and block.
SSD1<-lmer(pupa~sex+(1|line) +(1|block), REML=TRUE, data=df1)
summary(SSD1)
anova(SSD1)
```
SSD still exists at 1 day starvation




### 2 day starvation data
```{r}
#subsetting day 2 starvation 
df2<-subset(df_sub, day==2) #3111 rows
#na.omit only if pupa has NA
df2<-na.omit(df2, cols="pupa") #2573 rows
```

```{r}
# Testing effect of sex in pupa size, with random effect for line and block.
SSD2<-lmer(pupa~sex+(1|line) +(1|block), REML=TRUE, data=df2)
summary(SSD2)
anova(SSD2)
```

SSD still exists at 2 day starvation


How do I see if the SSD between treatment is the same? If it is the same, it will be correlated? But that doesn't mean that if they are correlated, they are from the same female variation. So let's test that

```{r}
#calculate SSD for each treatment

#SSD1
# calculate size mean for male and female
#head(df1)
df1_mean<-aggregate(df1[, 8], list(df1$group), mean)
#head(df1_mean)

#re-add line, day and sex columns
df1_mean<-df1_mean %>%
  separate(Group.1, c("line", "sex","day"), "_")
head(df1_mean)


```



```{r}
#separating males and females to put the values in columns
df1_mean_F<-subset(df1_mean, sex=="F")
df1_mean_M<-subset(df1_mean, sex=="M")

df1_mean_2<-merge(x=df1_mean_F, y=df1_mean_M, by.x="line", by.y="line")
head(df1_mean_2)

#remove extra columns
df1_mean_2<-df1_mean_2[,c(1,4,7)] 
colnames(df1_mean_2) <- c("line", "pupaF1", "pupaM1")

df1_mean<-df1_mean_2
df1_mean$SSD1<- df1_mean$pupaF1 - df1_mean$pupaM1  #since we established that females are larger than males in general
head(df1_mean)


```

```{r}

#SSD 2

# calculate size mean for male and female
#head(df1)
df2_mean<-aggregate(df2[, 8], list(df2$group), mean)
#head(df1_mean)

#re-add line, day and sex columns
df2_mean<-df2_mean %>%
  separate(Group.1, c("line", "sex","day"), "_")
head(df2_mean)


#separating males and females to put the values in columns
df2_mean_F<-subset(df2_mean, sex=="F")
df2_mean_M<-subset(df2_mean, sex=="M")

df2_mean_2<-merge(x=df2_mean_F, y=df2_mean_M, by.x="line", by.y="line")
head(df2_mean_2)

#remove extra columns
df2_mean_2<-df2_mean_2[,c(1,4,7)] 
colnames(df2_mean_2) <- c("line", "pupaF2", "pupaM2")

df2_mean<-df2_mean_2
df2_mean$SSD2<- df2_mean$pupaF2 - df2_mean$pupaM2  #since we established that females are larger than males in general
head(df2_mean)


```

```{r}
#merge all SSDs

SSD01<-merge(x=df0_mean, y=df1_mean,by.x="line", by.y="line" )
SSDall<-merge(x=SSD01, y=df2_mean,by.x="line", by.y="line" )
head(SSDall)
```
Correlation between SSDs. Hypothesis, if SSD changes with environment, which is what we expect, we will not see a correlation between SSD0 and SSD1 and/or SSD2

```{r}
#correlation SSD0, SSD1, SSD2
SSDonly<-SSDall[,c(1,4,7,10)] 
head(SSDonly)

corr.test(SSDonly[2:4],
          use    = "pairwise",
          method = "pearson",
          adjust = "none")

chart.Correlation(SSDonly[2:4],
                   method="pearson",
                   histogram=TRUE,
                   pch=16)
```
There is a small correlation between SSD0 and SSD2. 

Overall, SSD's in different environment do not have a tight correlation between each other. So it seems that SSD changes in different food conditions, does it increase or decrease?


##Question 2.2: Does SSD increase or decrease when the flies are starved? Our hypothesis is that overall SSD should decrease

```{r}
SSDonly2<-SSDonly %>% gather(day, SSD, SSD0:SSD2)
head(SSDonly2)
# plotting male and female size mean
SSDonly2 %>%
  ggplot( aes(x=day, y=SSD)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="black", size=0.4, alpha=0.2) +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("Sexual Size Dimorphism in DGRP flies") +
    xlab("")


```
#NOT FINISHED
```{r}
#Male and Female size comparison per food
df_mean<-aggregate(df[, 8], list(df$group), mean)
#re-add line, day and sex columns
df_mean<-df_mean %>%
  separate(Group.1, c("line", "sex","day"), "_")
head(df_mean)


compare_means(pupa~sex , data = df_mean, 
              group.by = "day", paired = TRUE)
              
              # Box plot facetted by "dose"
p <- ggpaired(df_mean, x = "sex", y = "pupa",
          color = "day", palette = "jco", 
          line.color = "gray", line.size = 0.4,
          facet.by = "day", short.panel.labs = FALSE)
# Use only p.format as label. Remove method name.
p + stat_compare_means(label = "p.format", paired = TRUE)

```


It looks that overall, average SSD decreases between fed and starved flies. Is this a significant decrease?

I just want to compare the means of SSD.

```{r}
#ANOVA on SSD per day
head(SSDonly2)
SSDtest<-aov(data=SSDonly2, SSD ~day)
summary(SSDtest)
plot(SSDtest)


model.tables(SSDtest, type="means", se = TRUE)


#Pairwise comparison
TukeyHSD(SSDtest, which = "day")
```

We see that when starved, SSD decreases significantly but the number of days does not change the SSD.


## Question 2.3: Does the SSD in starved conditions vary the same way as in fed flies?
First, we want to see if there is genetic variation in SSD1 and SSD2
### SSD1
```{r}
#Comparing two model fit for SSD1 to see if there is genetic variation

model2<-lmer(pupa~sex+(1|line)+(1|block), data=df1)  #model to test for SSD presence as we did above
model1<-lmer(pupa~sex+(sex|line)+(1|block), data=df1) 
anova(model1)
anova(model1,model2)
```


Model 1 is better, as AIC and BIC is smaller and log likelihood is higher. The difference of fit between these two models is significant.

### Do a LRT
How many parameters for each models
```{r,message=FALSE, warning=FALSE}
(AIC(model1) - REMLcrit(model1))/2 # # of parameters the model "thinks" are being estimated
(AIC(model2) - REMLcrit(model2))/2 # # of parameters the model "thinks" are being estimated

```


So lme4/lmer is treating model 1 as having two more parameters than model2.
```{r,message=FALSE, warning=FALSE}
LR.model <-  -as.numeric(REMLcrit(model1) - REMLcrit(model2))
LR.model
nlevels(df1$line)
pchisq(q = LR.model, df=2, lower=F)
pchisq(q = LR.model, df=nlevels(df1$line), lower=F)
```

### Parametric boostrap
Finally, we can conduct a parametric bootstrap to compare the two models.

```{r echo=FALSE, message = FALSE, warning=FALSE}
pbtest<-PBmodcomp(model1, model2, nsim=1000, details = 1)
summary(pbtest)
```

### Finally using Bayesian Analysis

```{r,message=FALSE, warning=FALSE}
prior.2 <-list(R=list(V=0.01, nu=0.002), 
               G=list(G1=list(V=0.01*diag(1), nu=0.002),
                      G2=list(V=0.01*diag(2), nu=0.002)))

model1M.MCMC <- MCMCglmm(pupa ~ 1 + sex, 
  random=~block + us(1 + sex):line,
  prior = prior.2, burnin = 5000, nitt = 20000, thin = 10,
  verbose = F, pr = T,
  data=df0)
summary(model1M.MCMC)
```



### Post model 1 fitting check

#### Residual distribution
```{r,message=FALSE, warning=FALSE}
res_model1=residuals(model1)
```

#### Model 1 residual distribution

```{r,message=FALSE, warning=FALSE}
plot(model1)
```




#### QQ plot
```{r,message=FALSE, warning=FALSE}
require(ggpubr)
ggqqplot(res_model1)
```


#### Random effect plot
```{r,message=FALSE, warning=FALSE}
qqmath(ranef(model1))
```
We have two plots, one for line and one for block




### SSD2
```{r}
#Comparing two model fit for SSD2 to see if there is genetic variation

model2<-lmer(pupa~sex+(1|line)+(1|block), data=df2)  #model to test for SSD presence as we did above
model1<-lmer(pupa~sex+(sex|line)+(1|block), data=df2) 
anova(model1)
anova(model1,model2)
```


Model 1 is better, as AIC and BIC is smaller and log likelihood is higher. The difference of fit between these two models is significant.

### Do a LRT
How many parameters for each models
```{r,message=FALSE, warning=FALSE}
(AIC(model1) - REMLcrit(model1))/2 # # of parameters the model "thinks" are being estimated
(AIC(model2) - REMLcrit(model2))/2 # # of parameters the model "thinks" are being estimated

```


So lme4/lmer is treating model 1 as having two more parameters than model2.
```{r,message=FALSE, warning=FALSE}
LR.model <-  -as.numeric(REMLcrit(model1) - REMLcrit(model2))
LR.model
nlevels(df1$line)
pchisq(q = LR.model, df=2, lower=F)
pchisq(q = LR.model, df=nlevels(df1$line), lower=F)
```

### Parametric boostrap
Finally, we can conduct a parametric bootstrap to compare the two models.

```{r echo=FALSE, message = FALSE, warning=FALSE}
pbtest<-PBmodcomp(model1, model2, nsim=1000, details = 1)
summary(pbtest)
```

### Finally using Bayesian Analysis

```{r,message=FALSE, warning=FALSE}
prior.2 <-list(R=list(V=0.01, nu=0.002), 
               G=list(G1=list(V=0.01*diag(1), nu=0.002),
                      G2=list(V=0.01*diag(2), nu=0.002)))

model1M.MCMC <- MCMCglmm(pupa ~ 1 + sex, 
  random=~block + us(1 + sex):line,
  prior = prior.2, burnin = 5000, nitt = 20000, thin = 10,
  verbose = F, pr = T,
  data=df0)
summary(model1M.MCMC)
```



### Post model 1 fitting check

#### Residual distribution
```{r,message=FALSE, warning=FALSE}
res_model1=residuals(model1)
```

#### Model 1 residual distribution

```{r,message=FALSE, warning=FALSE}
plot(model1)
```




#### QQ plot
```{r,message=FALSE, warning=FALSE}
require(ggpubr)
ggqqplot(res_model1)
```


#### Random effect plot
```{r,message=FALSE, warning=FALSE}
qqmath(ranef(model1))
```
We have two plots, one for line and one for block


SSD1 and SSD2 vary also significantly.

Does that variation correlate with SSD0?

If they vary the same way, we should see a correlation. It was tested earlier that no. We can visualize how SSD changes across lineages too.

```{r}
library(tidyverse)

ggplot(SSDonly2, aes(x=reorder(line,SSD), y=SSD)) +
  geom_col(aes(fill = day)) +
  facet_wrap(~ day) +
  coord_flip()



```


Since there is just a weak correlation between SSD0 and SSD2, I want to know if SSD1 and SSD2 varies because of female size variation as found in SSD0.

Correlation test between SSD1 and female and male size

```{r}
SSD1_size<-SSDall[,c(1,5:7)]

library(psych)

corr.test(SSD1_size[2:4],
          use    = "pairwise",
          method = "pearson",
          adjust = "none")
```


```{r}

library(PerformanceAnalytics)

chart.Correlation(SSD1_size[2:4],
                   method="pearson",
                   histogram=TRUE,
                   pch=16)
```



Correlation SSD2 and female and male size
```{r}
SSD2_size<-SSDall[,c(1,8:10)]

library(psych)

corr.test(SSD2_size[2:4],
          use    = "pairwise",
          method = "pearson",
          adjust = "none")
```


```{r}

library(PerformanceAnalytics)

chart.Correlation(SSD2_size[2:4],
                   method="pearson",
                   histogram=TRUE,
                   pch=16)
```

In all cases, female size seems to covary at least partly with the SSD in different conditions.


FIND HOW WE CAN COMPARE CORRELATIONS OF SSD vs female, SSD1 vs female 1, and SSD2 vs female2

We have shown that SSD in different condition changes, and that the variation of SSD partly covariates with female size variation. But the degree of correlation varies.

But if SSD changes under different conditions, that means that female and males must have a different response to environemental change, so sex specific plasticity or SSP must differ.

#Section 3: SSP01 and SSP02
  - Question 3.1: Is there SSP when we look at fed vs starved flies?
  - Question 3.2: Does this SSP vary in the DGRP flies?
  - Question 3.3: Is the variation in SSP due to a variation in SSD in fed or starved flies?
If SSP covaries with SSD0, that means that we have variation in fed flies. If SSP covaries with starved flies, we have variation in the reduction of flies size.
  - Question 3.4: If it is due to SSD in either fed or starved flies, is it because the females vary more or the males vary more in size?
  - Question 3.5: Does the variation causing SSP (Question 3.4) is the same as the variation caused by SSD in Question 1.3?


##Question 3.1: Is there SSP when we look at fed vs starved flies?

### SSP01: between fed and 1 day starved flies
```{r}
# use subset Day 1 and Day 0
df01<-subset(df, day==0|day==1)

SSP<-lmer(pupa~sex+(sex+day|line)+(1|block), REML=TRUE, data=df01) #random effect, there is variation in sex by line and there is variation in plasticity by line.
summary(SSP)
Anova(SSP)

```

### SSP02: between fed and 1 day starved flies
```{r}
# use subset Day 1 and Day 0
df02<-subset(df, day==0|day==2)

SSP<-lmer(pupa~sex+(sex+day|line)+(1|block), REML=TRUE, data=df02) #random effect, there is variation in sex by line and there is variation in plasticity by line.
summary(SSP)
Anova(SSP)

```




##Question 3.2: Does this SSP vary in the DGRP flies?
### SSP01
```{r,message=FALSE, warning=FALSE}
# we want to compare effect of sex and day of starvation on pupal size.
model2<-lmer(pupa~sex+(sex+day|line)+(1|block), data=df01)
model1<-lmer(pupa~sex+(sex*day|line)+(1|block), data=df01)
anova(model1,model2)
```


In that case model 1 is better.


### SSP02
```{r,message=FALSE, warning=FALSE}
# we want to compare effect of sex and day of starvation on pupal size.
model2<-lmer(pupa~sex+(sex+day|line)+(1|block), data=df02)
model1<-lmer(pupa~sex+(sex*day|line)+(1|block), data=df02)
anova(model1,model2)
```

Model 1 is better here.

##Question 3.3: Is the variation in SSP due to a variation in SSD in fed or starved flies?
Look at the correlation between SSP01, SSD0 and SSD1




Look at the correlation between SSP02, SSD0 and SSD2



























#Plasticity 0 1

Variation in SSP could be the result of variation in only female or male plasticity. We can look at the plasticity in each sex.

```{r,message=FALSE, warning=FALSE}
#dataset was manually relabeled
df <- read.csv("~/Dropbox/_Github_reps/DGRP_SSDSSP/Sept2020/DGRPfinal_clean_labels.csv")

#line and day of treatment as categorical
df$line<-as.factor(df$line)
df$day<-as.factor(df$day)
df$block<-as.factor(df$block)
#summary of data
summary(df)

#remove all NAs, most functions do not deal with NAs well
df<-na.omit(df)
```



Do we have variation in plasticity in females?
```{r,message=FALSE, warning=FALSE}
dfcF<-subset(df, df$type == "exp" & df$sex =="F")
head(dfcF)

model1F<-lmer(pupa~day+(1|line)+(1|block), data=dfcF)
model2F<-lmer(pupa~day+(day|line)+(1|block), data=dfcF)
anova(model1F, model2F)
```

Do we have variation fo plasticity in males?

```{r,message=FALSE, warning=FALSE}
dfcM<-subset(df, df$type == "exp" & df$sex =="M")

model1M<-lmer(pupa~day+(1|line)+(1|block), data=dfcM)
model2M<-lmer(pupa~day+(day|line)+(1|block), data=dfcM)
anova(model1M, model2M)
```

Can we directly compare variation in plasticity between males and females?
```{r}
#calculate plasticity female
dfcF1<-subset(dfcF, day ==1)
dfcF1_mean<-aggregate(dfcF1[, 9], list(dfcF1$line), mean)
colnames(dfcF1_mean)<-c("line","pupaFmean_1")
head(dfcF1_mean)

dfcF0<-subset(dfcF, day ==0)
head(dfcF0)
dfcF0_mean<-aggregate(dfcF0[, 9], list(dfcF0$line), mean)
colnames(dfcF0_mean)<-c("line","pupaFmean_0")
head(dfcF0_mean)

dfcF2<-subset(dfcF, day ==2)
head(dfcF2)
dfcF2_mean<-aggregate(dfcF2[, 9], list(dfcF2$line), mean)
colnames(dfcF2_mean)<-c("line","pupaFmean_2")
head(dfcF2_mean)

pupa_mean_F01<-merge(x=dfcF0_mean, y=dfcF1_mean, by.x="line", by.y="line")
head(pupa_mean_F01)
pupa_mean_F012<-merge(x=pupa_mean_F01, y=dfcF2_mean, by.x="line", by.y="line")

pupa_mean_F012$PF01<-pupa_mean_F012$pupaFmean_0-pupa_mean_F012$pupaFmean_1
pupa_mean_F012$PF02<-pupa_mean_F012$pupaFmean_0-pupa_mean_F012$pupaFmean_2
pupa_mean_F012$PF12<-pupa_mean_F012$pupaFmean_1-pupa_mean_F012$pupaFmean_2

head(pupa_mean_F012)
```

```{r}
#calculate plasticity male
dfcM1<-subset(dfcM, day ==1)
dfcM1_mean<-aggregate(dfcM1[, 9], list(dfcM1$line), mean)
colnames(dfcM1_mean)<-c("line","pupaMmean_1")
head(dfcM1_mean)

dfcM0<-subset(dfcM, day ==0)
head(dfcM0)
dfcM0_mean<-aggregate(dfcM0[, 9], list(dfcM0$line), mean)
colnames(dfcM0_mean)<-c("line","pupaMmean_0")
head(dfcM0_mean)

dfcM2<-subset(dfcM, day ==2)
head(dfcM2)
dfcM2_mean<-aggregate(dfcM2[, 9], list(dfcM2$line), mean)
colnames(dfcM2_mean)<-c("line","pupaMmean_2")
head(dfcM2_mean)

pupa_mean_M01<-merge(x=dfcM0_mean, y=dfcM1_mean, by.x="line", by.y="line")
head(pupa_mean_M01)
pupa_mean_M012<-merge(x=pupa_mean_M01, y=dfcM2_mean, by.x="line", by.y="line")

pupa_mean_M012$PM01<-pupa_mean_M012$pupaMmean_0-pupa_mean_M012$pupaMmean_1
pupa_mean_M012$PM02<-pupa_mean_M012$pupaMmean_0-pupa_mean_M012$pupaMmean_2
pupa_mean_M012$PM12<-pupa_mean_M012$pupaMmean_1-pupa_mean_M012$pupaMmean_2



head(pupa_mean_M012)
```


```{r}
library(ggplot2)
library(lattice)
library(Deducer)
pupa_SSP<-merge(x= pupa_mean_M012, y= pupa_mean_F012, by.x="line", by.y="line")
head(pupa_SSP)
pupa_SSP$SSP01<-pupa_SSP$PF01-pupa_SSP$PM01
pupa_SSP$SSP02<-pupa_SSP$PF02-pupa_SSP$PM02
pupa_SSP$SSP12<-pupa_SSP$PF12-pupa_SSP$PM12
#pairs(pupa_SSP)
pupa_SSP<-na.omit(pupa_SSP)

head(pupa_SSP)
pupa_summary<-pupa_SSP


pupa_summary$SSD0<-pupa_summary$pupaFmean_0-pupa_summary$pupaMmean_0
pupa_summary$SSD1<-pupa_summary$pupaFmean_1-pupa_summary$pupaMmean_1
pupa_summary$SSD2<-pupa_summary$pupaFmean_2-pupa_summary$pupaMmean_2

head(pupa_summary)

```


```{r}
panel.cor <- function(x, y, digits=2, prefix="", cex.cor) 
{
    usr <- par("usr"); on.exit(par(usr)) 
    par(usr = c(0, 1, 0, 1)) 
    r <- abs(cor(x, y)) 
    txt <- format(c(r, 0.123456789), digits=digits)[1] 
    txt <- paste(prefix, txt, sep="") 
    if(missing(cex.cor)) cex <- 0.8/strwidth(txt) 
 
    test <- cor.test(x,y, method="pearson") 
    # borrowed from printCoefmat
    Signif <- symnum(test$p.value, corr = FALSE, na = FALSE, 
                  cutpoints = c(0, 0.001, 0.01, 0.05, 0.1, 1),
                  symbols = c("***", "**", "*", ".", " ")) 
 
    text(0.5, 0.5, txt, cex = cex * r) 
    text(.8, .8, Signif, cex=cex, col=2) 
}

```


#WINGS

### How much bigger are female wings compared to males

```{r,message=FALSE, warning=FALSE}
df0$sex

wingdf0<-subset(df0, df0$wing >=12)
meanwing<-tapply(df0$wing, df0$sex, summary)

(exp(meanwing$F[[4]]) -exp(meanwing$M[[4]]))/exp(meanwing$M[[4]])*100

```
Wings are 21% larger in females than males




# FECUNDITY and size
### Work on this later
```{r}
fec<-read.csv("Sept2020/Fecundity_mean_Durham.csv", header=TRUE)
fec_femsize<-merge(x=fec,y=pupa_summary, by.x = "line",by.y = "line")
head(fec_femsize)

#pairs(fec_femsize[3:21], lower.panel=panel.smooth, upper.panel=panel.cor)
```

#SSP and SSD correlation

```{r}
#checking the correlations between SSP and SSD
pairs(fec_femsize[16:21], lower.panel=panel.smooth, upper.panel=panel.cor)



```



The highest covariation is found between SSP02 and SSD2, which means that either female size varies a lot at day2 starvation or male size varies a lot at day 2 starvation. To test that, we plot SSP02 with pupa size for each sex. If there SSP02 is associated with variation of female size at d2, we should see a negative correlation for female size d2 and SSP02. And the other way if male variation is responsible.


Another function to check for correlation
```{r}
library(psych)

corr.test(fec_femsize[16:21],
          use    = "pairwise",
          method = "pearson",
          adjust = "none")
```


```{r}

library(PerformanceAnalytics)

chart.Correlation(fec_femsize[16:21],
                   method="pearson",
                   histogram=TRUE,
                   pch=16)
```
This function shows the variable distribution and which correlation is negative in the Rsquare.


```{r}
head(pupa_summary)
pupa_SSP02 <- pupa_summary[c(4,10,15)]
                  
pairs(pupa_SSP02[1:3], lower.panel=panel.smooth, upper.panel=panel.cor)

```




I want to see if there is a correlation between female size and fecundity

```{r}
library(ggplot2)
g <- ggplot(fec_femsize, aes(lnpupa, ltf))
g + geom_point() + 
  geom_smooth(method="lm", se=F) +
  labs(subtitle=" ", 
       y="ltf", 
       x="lnpupa", 
       title=" ")
```


```{r}
#week 1 fecundity
g <- ggplot(fec_femsize, aes(lnpupa, w1f))
g + geom_point() + 
  geom_smooth(method="lm", se=F) +
  labs(subtitle=" ", 
       y="w1f", 
       x="lnpupa", 
       title=" ")

```