---
title: "DGRP Genetic Arch"
author: "Alexander Shingleton"
date: "9/8/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressPackageStartupMessages({
 require(lme4)
require(lmerTest)
require(lattice) # for some of the simple plots
require(MCMCglmm) # To get posterior distributions
require(smatr)
require(dplyr)
require(plyr)
require(rrcov)
require(tibble)
require(ggplot2)
require(ggalt)
require(varhandle)
require(magrittr)
require("ggthemes")
require(pbkrtest)  # parametric bootstrap
library(car)
 })
R.version
```




#Preamble
```{r,message=FALSE, warning=FALSE}
#dataset was manually relabeled
df <- read.csv("~/Dropbox/_Github_reps/DGRP_SSDSSP/Sept2020/DGRPfinal_clean_labels.csv")

#line and day of treatment as categorical
df$line<-as.factor(df$line)
df$day<-as.factor(df$day)
df$block<-as.factor(df$block)
#summary of data
summary(df)

#remove all NAs, most functions do not deal with NAs well
df<-na.omit(df)


```



# Filtering out lines with few data
```{r}
#subsetting experimental flies only

df_exp<-subset(df, type == "exp")
df<-df_exp

#filtering out groups (line x sex x day) that have less than 10 flies
df_f<-subset(df, sex =="F")
df_f0<-subset(df_f, day =="0")
df_f1<-subset(df_f, day =="1")
df_f2<-subset(df_f, day =="2")

#F0
df_subf0<-df_f0%>%
group_by(line) %>%
filter(n() >=10)

length(unique(df_subf0$line)) 

#F1
df_subf1<-df_f1%>%
group_by(line) %>%
filter(n() >=10)

length(unique(df_subf1$line))  

#F2
df_subf2<-df_f2%>%
group_by(line) %>%
filter(n() >=10)

length(unique(df_subf2$line))  

df_m<-subset(df, sex =="M")
df_m0<-subset(df_m, day =="0")
df_m1<-subset(df_m, day =="1")
df_m2<-subset(df_m, day =="2")

#M0
df_subm0<-df_m0%>%
group_by(line) %>%
filter(n() >=10)

length(unique(df_subm0$line)) 

#M1
df_subm1<-df_m1%>%
group_by(line) %>%
filter(n() >=10)

length(unique(df_subm1$line))  

#M2
df_subm2<-df_m2%>%
group_by(line) %>%
filter(n() >=10)

length(unique(df_subm2$line))  



```

#rebinding dataframes

```{r}
df0<-rbind(df_subm0, df_subf0)
df0<-na.omit(df0)
length(unique(df0$line))  #182 lineages
length(unique(df0$type))

```


#Is there variation among blocks
Flies of lineages were collected in different blocks, periods of time. Control lineages were selected and collected repeatedly for each block so that if there is variation, we can account for that factor.

Look at the control lineages to see whether there is variation among blocks

```{r,message=FALSE, warning=FALSE}
#subset control lineages
df0<-subset(df, day =='0')
dfc<-subset(df0, type=="ct")
dfcf<-subset(dfc, sex=="F")
dfcm<-subset(dfc, sex=="M")


#linear mixed model testing pupa size variation and if block factor has an effect on the variation
blocktest<-lmer(pupa~block+(1|line), data=dfc)
Anova(blocktest, type="III")

blocktest2<-lmer(pupa~sex*block+(1|line), data=dfc)
Anova(blocktest2, type="III")

blocktestF<-lmer(pupa~block+(1|line), data=dfcf)
Anova(blocktest, type="III")

blocktestM<-lmer(pupa~block+(1|line), data=dfcm)
Anova(blocktest, type="III")
```

There is a difference between collecting blocks so we have to account for block as a random factor, or adjust the values so there is no variation between blocks.




# SSD

## Is there SSD? Using only fed flies (day=0)
To test if we have sexual size dimorphism, we want to test the effect of size with line and block as random factor. If there is a variation due to sex, that means SSD is present.

```{r,message=FALSE, warning=FALSE}
#subsetting day 0, fed flies
df0<-subset(df, day==0)

SSD<-lmer(pupa~sex+(1|line) +(1|block), REML=TRUE, data=df0)
summary(SSD)
anova(SSD)
```

## Does SSD vary among lineages?
Now we want to know if that SSD varies between lines.

```{r,message=FALSE, warning=FALSE}

model2<-lmer(pupa~sex+(1|line)+(1|block), data=df0)  #model to test for SSD presence as we did above
model1<-lmer(pupa~sex+(sex|line)+(1|block), data=df0) 
anova(model1)
anova(model1,model2)
```
Model 1 is better, as AIC and BIC is smaller and log likelihood is higher. The difference of fit between these two models is significant.

Do a LRT

```{r,message=FALSE, warning=FALSE}
(AIC(model1) - REMLcrit(model1))/2 # # of parameters the model "thinks" are being estimated
(AIC(model2) - REMLcrit(model2))/2 # # of parameters the model "thinks" are being estimated

```


So lme4/lmer is treating model 1 as having two more parameters than model2.
```{r,message=FALSE, warning=FALSE}
LR.model <-  -as.numeric(REMLcrit(model1) - REMLcrit(model2))
LR.model
nlevels(df$line)
pchisq(q = LR.model, df=2, lower=F)
pchisq(q = LR.model, df=nlevels(df$line), lower=F)
```
Finally, we can conduct a parametric bootstrap to compare the two models.

```{r echo=FALSE, message = FALSE, warning=FALSE}
pbtest<-PBmodcomp(model1, model2, nsim=1000, details = 1)
summary(pbtest)
```

Finally using Bayesian Analysis

```{r,message=FALSE, warning=FALSE}
prior.2 <-list(R=list(V=0.01, nu=0.002), 
               G=list(G1=list(V=0.01*diag(1), nu=0.002),
                      G2=list(V=0.01*diag(2), nu=0.002)))

model1M.MCMC <- MCMCglmm(pupa ~ 1 + sex, 
  random=~block + us(1 + sex):line,
  prior = prior.2, burnin = 5000, nitt = 20000, thin = 10,
  verbose = F, pr = T,
  data=df0)
summary(model1M.MCMC)
```



### Post model fitting check

#### Residual distribution
```{r,message=FALSE, warning=FALSE}
res_model1=residuals(model1)
```
Model 1 residual distribution

```{r,message=FALSE, warning=FALSE}
plot(model1)
```



Model 1 residual distribution per random factor


QQ plot
```{r,message=FALSE, warning=FALSE}
qqnorm(res_model1)
```


Random effect plot
```{r,message=FALSE, warning=FALSE}
qqmath(ranef(model1))
```



#SSP

## Is there a difference in plasticity between males and females = presence of SSP?
```{r}

# use subset Day 1 and Day 0
df01<-subset(df, day==0|day==1)

SSP<-lmer(pupa~sex+(sex+day|line)+(1|block), REML=TRUE, data=df01) #random effect, there is variation in sex by line and there is variation in plasticity by line.
summary(SSP)
Anova(SSP)

```

##Does SSP vary among lineages?

```{r,message=FALSE, warning=FALSE}
# we want to compare effect of sex and day of starvation on pupal size.
model2<-lmer(pupa~sex+(sex+day|line)+(1|block), data=df)
model1<-lmer(pupa~sex+(sex*day|line)+(1|block), data=df)
anova(model1,model2)
```


#Plasticity 0 1

Variation in SSP could be the result of variation in only female or male plasticity. We can look at the plasticity in each sex.

```{r,message=FALSE, warning=FALSE}
#dataset was manually relabeled
df <- read.csv("~/Dropbox/_Github_reps/DGRP_SSDSSP/Sept2020/DGRPfinal_clean_labels.csv")

#line and day of treatment as categorical
df$line<-as.factor(df$line)
df$day<-as.factor(df$day)
df$block<-as.factor(df$block)
#summary of data
summary(df)

#remove all NAs, most functions do not deal with NAs well
df<-na.omit(df)
```



Do we have variation in plasticity in females?
```{r,message=FALSE, warning=FALSE}
dfcF<-subset(df, df$type == "exp" & df$sex =="F")
head(dfcF)

model1F<-lmer(pupa~day+(1|line)+(1|block), data=dfcF)
model2F<-lmer(pupa~day+(day|line)+(1|block), data=dfcF)
anova(model1F, model2F)
```

Do we have variation fo plasticity in males?

```{r,message=FALSE, warning=FALSE}
dfcM<-subset(df, df$type == "exp" & df$sex =="M")

model1M<-lmer(pupa~day+(1|line)+(1|block), data=dfcM)
model2M<-lmer(pupa~day+(day|line)+(1|block), data=dfcM)
anova(model1M, model2M)
```

Can we directly compare variation in plasticity between males and females?
```{r}
#calculate plasticity female
dfcF1<-subset(dfcF, day ==1)
dfcF1_mean<-aggregate(dfcF1[, 9], list(dfcF1$line), mean)
colnames(dfcF1_mean)<-c("line","pupaFmean_1")
head(dfcF1_mean)

dfcF0<-subset(dfcF, day ==0)
head(dfcF0)
dfcF0_mean<-aggregate(dfcF0[, 9], list(dfcF0$line), mean)
colnames(dfcF0_mean)<-c("line","pupaFmean_0")
head(dfcF0_mean)

dfcF2<-subset(dfcF, day ==2)
head(dfcF2)
dfcF2_mean<-aggregate(dfcF2[, 9], list(dfcF2$line), mean)
colnames(dfcF2_mean)<-c("line","pupaFmean_2")
head(dfcF2_mean)

pupa_mean_F01<-merge(x=dfcF0_mean, y=dfcF1_mean, by.x="line", by.y="line")
head(pupa_mean_F01)
pupa_mean_F012<-merge(x=pupa_mean_F01, y=dfcF2_mean, by.x="line", by.y="line")

pupa_mean_F012$PF01<-pupa_mean_F012$pupaFmean_1-pupa_mean_F012$pupaFmean_0
pupa_mean_F012$PF02<-pupa_mean_F012$pupaFmean_2-pupa_mean_F012$pupaFmean_0
pupa_mean_F012$PF12<-pupa_mean_F012$pupaFmean_2-pupa_mean_F012$pupaFmean_1

head(pupa_mean_F012)
```

```{r}
#calculate plasticity male
dfcM1<-subset(dfcM, day ==1)
dfcM1_mean<-aggregate(dfcM1[, 9], list(dfcM1$line), mean)
colnames(dfcM1_mean)<-c("line","pupaMmean_1")
head(dfcM1_mean)

dfcM0<-subset(dfcM, day ==0)
head(dfcM0)
dfcM0_mean<-aggregate(dfcM0[, 9], list(dfcM0$line), mean)
colnames(dfcM0_mean)<-c("line","pupaMmean_0")
head(dfcM0_mean)

dfcM2<-subset(dfcM, day ==2)
head(dfcM2)
dfcM2_mean<-aggregate(dfcM2[, 9], list(dfcM2$line), mean)
colnames(dfcM2_mean)<-c("line","pupaMmean_2")
head(dfcM2_mean)

pupa_mean_M01<-merge(x=dfcM0_mean, y=dfcM1_mean, by.x="line", by.y="line")
head(pupa_mean_M01)
pupa_mean_M012<-merge(x=pupa_mean_M01, y=dfcM2_mean, by.x="line", by.y="line")

pupa_mean_M012$PM01<-pupa_mean_M012$pupaMmean_1-pupa_mean_M012$pupaMmean_0
pupa_mean_M012$PM02<-pupa_mean_M012$pupaMmean_2-pupa_mean_M012$pupaMmean_0
pupa_mean_M012$PM12<-pupa_mean_M012$pupaMmean_2-pupa_mean_M012$pupaMmean_1

head(pupa_mean_M012)
```


```{r}
library(ggplot2)
library(lattice)
library(Deducer)
pupa_SSP<-merge(x= pupa_mean_M012, y= pupa_mean_F012, by.x="line", by.y="line")
head(pupa_SSP)
pupa_SSP$SSP01<-pupa_SSP$PF01-pupa_SSP$PM01
pairs(pupa_SSP)
pupa_SSP<-na.omit(pupa_SSP)

```


```{r}
panel.cor <- function(x, y, digits=2, prefix="", cex.cor) 
{
    usr <- par("usr"); on.exit(par(usr)) 
    par(usr = c(0, 1, 0, 1)) 
    r <- abs(cor(x, y)) 
    txt <- format(c(r, 0.123456789), digits=digits)[1] 
    txt <- paste(prefix, txt, sep="") 
    if(missing(cex.cor)) cex <- 0.8/strwidth(txt) 
 
    test <- cor.test(x,y) 
    # borrowed from printCoefmat
    Signif <- symnum(test$p.value, corr = FALSE, na = FALSE, 
                  cutpoints = c(0, 0.001, 0.01, 0.05, 0.1, 1),
                  symbols = c("***", "**", "*", ".", " ")) 
 
    text(0.5, 0.5, txt, cex = cex * r) 
    text(.8, .8, Signif, cex=cex, col=2) 
}

```

```{r}
pairs(pupa_SSP[1:13], lower.panel=panel.smooth, upper.panel=panel.cor)


```




#WINGS

### How much bigger are female wings compared to males

```{r,message=FALSE, warning=FALSE}
df0$sex

wingdf0<-subset(df0, df0$wing >=12)
meanwing<-tapply(df0$wing, df0$sex, summary)

(exp(meanwing$F[[4]]) -exp(meanwing$M[[4]]))/exp(meanwing$M[[4]])*100

```
Wings are 21% larger in females than males




# FECUNDITY and size

```{r}
fec<-read.csv("Sept2020/Fecundity_mean_Durham.csv", header=TRUE)
fec_femsize<-merge(x=fec,y=pupa_SSP, by.x = "line",by.y = "line")
head(fec_femsize)

pairs(fec_femsize[2:16], lower.panel=panel.smooth, upper.panel=panel.cor)

```

I want to see if there is a correlation between female size and fecundity

```{r}
library(ggplot2)
g <- ggplot(fec_femsize, aes(lnpupa, ltf))
g + geom_point() + 
  geom_smooth(method="lm", se=F) +
  labs(subtitle=" ", 
       y="ltf", 
       x="lnpupa", 
       title=" ")
```


```{r}
#week 1 fecundity
g <- ggplot(fec_femsize, aes(lnpupa, w1f))
g + geom_point() + 
  geom_smooth(method="lm", se=F) +
  labs(subtitle=" ", 
       y="w1f", 
       x="lnpupa", 
       title=" ")

```